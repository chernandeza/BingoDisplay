<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Bingo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="tablero-body">
    <div class="page page--tablero">
        <header class="page-header">
            <div class="title-group">
                <h1>Tablero de Bingo</h1>
                <p class="subtitle">Se actualiza automáticamente al ingresar nuevos números.</p>
                <a class="nav-link" href="{{ url_for('ingresar') }}">Ir al panel de ingreso</a>
            </div>
        </header>

        <main class="layout-tablero">
            <section class="current-call current-call--solo">
                <h2>Última llamada</h2>
                <div class="call-card" id="tarjeta-llamada">
                    {% if ultima_llamada %}
                        <div class="call-letter" id="letra-llamada">{{ number_to_letter(ultima_llamada) }}</div>
                        <div class="call-number" id="numero-llamada">{{ ultima_llamada }}</div>
                    {% else %}
                        <div class="call-letter" id="letra-llamada">—</div>
                        <div class="call-number" id="numero-llamada">—</div>
                    {% endif %}
                </div>
                <p class="hint status-note">Esta pantalla se actualiza cada pocos segundos.</p>
            </section>

            <section class="board">
                <h2>Números cantados</h2>
                <div class="grid" role="grid" aria-label="Números cantados">
                    <div class="grid-row grid-header" role="row">
                        {% for letra in columnas.keys() %}
                        <div class="cell" role="columnheader">{{ letra }}</div>
                        {% endfor %}
                    </div>
                    {% for index in range(15) %}
                    <div class="grid-row" role="row">
                        {% for letra, numeros in columnas.items() %}
                            {% set valor = numeros[index] %}
                            {% set fue_llamado = valor in llamadas %}
                            <div class="cell {{ 'called' if fue_llamado else '' }}" role="gridcell" aria-label="{{ letra }}{{ valor }}" data-valor="{{ valor }}">
                                <span class="cell-text">{{ valor }}</span>
                            </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </section>
        </main>
    </div>

    <script>
        const letraElemento = document.getElementById('letra-llamada');
        const numeroElemento = document.getElementById('numero-llamada');
        const celdas = new Map();
        document.querySelectorAll('[data-valor]').forEach((celda) => {
            const valor = Number(celda.dataset.valor);
            celdas.set(valor, celda);
        });

        const estadoInicial = {
            ultima_llamada: {{ ultima_llamada if ultima_llamada is not none else 'null' }},
            llamadas: {{ llamadas|list|tojson }},
        };

        function letraPara(numero) {
            if (numero >= 1 && numero <= 15) return 'B';
            if (numero <= 30) return 'I';
            if (numero <= 45) return 'N';
            if (numero <= 60) return 'G';
            if (numero <= 75) return 'O';
            return '—';
        }

        function marcarLlamadas(lista) {
            celdas.forEach((celda) => celda.classList.remove('called'));
            lista.forEach((valor) => {
                const celda = celdas.get(Number(valor));
                if (celda) {
                    celda.classList.add('called');
                }
            });
        }

        function actualizarTarjeta(valor) {
            if (valor === null || valor === undefined) {
                letraElemento.textContent = '—';
                numeroElemento.textContent = '—';
                return;
            }
            letraElemento.textContent = letraPara(valor);
            numeroElemento.textContent = valor;
        }

        function aplicarEstado(estado) {
            actualizarTarjeta(estado.ultima_llamada);
            if (Array.isArray(estado.llamadas)) {
                marcarLlamadas(estado.llamadas);
            }
        }

        async function obtenerEstado() {
            try {
                const respuesta = await fetch('{{ url_for('estado') }}', { cache: 'no-store' });
                if (!respuesta.ok) return;
                const data = await respuesta.json();
                aplicarEstado(data);
            } catch (error) {
                console.error('No se pudo actualizar el tablero', error);
            }
        }

        aplicarEstado(estadoInicial);
        setInterval(obtenerEstado, 2500);
    </script>
</body>
</html>
